<main class="song-collection-root">
  <section class="song-collection-header">
    <div class="song-collection-header__titles">
      <h1>{{ headerTitle() }}</h1>
      @if (headerSubtitle()) {
        <p class="song-collection-header__subtitle">{{ headerSubtitle() }}</p>
      }
    </div>
    @if (headerControls().length || hasSortingOptions()) {
      <div class="song-collection-header-controls" role="toolbar" aria-label="Collection controls">
        @if (headerControls().length) {
          @for (control of headerControls(); track control.id ?? control.label) {
            @if (control.type === 'select') {
              <mat-form-field appearance="outline" class="song-collection-control">
                <mat-label>{{ control.label }}</mat-label>
                <mat-select
                  [value]="control.value"
                  (selectionChange)="control.onValueChange($event.value)"
                >
                  @for (option of control.options; track option.value) {
                    <mat-option [value]="option.value" [disabled]="option.disabled">
                      {{ option.label }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            } @else if (control.type === 'search') {
              <mat-form-field appearance="outline" class="song-collection-control">
                <mat-label>{{ control.label }}</mat-label>
                <input
                  matInput
                  type="search"
                  [value]="control.value"
                  [placeholder]="control.placeholder ?? control.label"
                  (input)="handleHeaderSearchInput(control, $event)"
                />
              </mat-form-field>
            }
          }
        }

        @if (hasSortingOptions()) {
          <div class="song-collection-sort-trigger">
            <button
              mat-icon-button
              type="button"
              [matMenuTriggerFor]="sortMenu"
              [attr.aria-label]="sortingLabel()"
              [attr.aria-expanded]="isSortingMenuOpen()"
            >
              <mat-icon>sort</mat-icon>
            </button>
            <mat-menu
              #sortMenu="matMenu"
              class="song-collection-sorting-menu"
              (opened)="onSortingMenuOpened()"
              (closed)="onSortingMenuClosed()"
              xPosition="before"
              yPosition="below"
            >
              <mat-chip-listbox
                multiple
                aria-label="Sort options"
                class="song-collection-sorting-panel__chip-list"
              >
                @for (option of sortingChips(); track option.key) {
                  <mat-chip
                    [color]="isSortingChipActive(option) ? 'primary' : undefined"
                    [class.song-collection-sorting-chip--active]="isSortingChipActive(option)"
                    [disabled]="option.disabled"
                    (click)="handleSortingChipClick(option); $event.stopPropagation()"
                    [attr.aria-pressed]="isSortingChipActive(option)"
                    role="button"
                  >
                    {{ option.label }}
                    @if (getSortingDirectionIcon(option)) {
                      <mat-icon matChipTrailingIcon aria-hidden="true">{{
                        getSortingDirectionIcon(option)
                      }}</mat-icon>
                    }
                  </mat-chip>
                }
              </mat-chip-listbox>
            </mat-menu>
          </div>
        }
      </div>
    }
  </section>

  @if (isInitialLoading()) {
    <div class="loading-state">
      <app-loading-skeleton
        [count]="skeletonCount()"
        [rows]="skeletonRows()"
        [cols]="skeletonCols()"
      />
    </div>
  } @else {
    <div class="scroll-container" #scrollContainer>
      @if (shouldShowEmptyState() && emptyStateTemplate()) {
        <ng-container *ngTemplateOutlet="emptyStateTemplate()"></ng-container>
      } @else {
        <app-song-list
          [songs]="visibleSongs()"
          [isUserLibrary]="isUserLibraryView()"
          [isSongInLibrary]="config().isSongInLibrary || defaultSongInLibrary"
          [isAuthenticated]="resolveIsAuthenticated()"
          (tileClick)="tileClick.emit($event)"
          (addToLibrary)="addToLibrary.emit($event)"
          (deleteClick)="deleteClick.emit($event)"
        />
      }

      @if (isPaginationLoading()) {
        <div class="pagination-loading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading more songs...</p>
        </div>
      }
    </div>
  }

  @if (error()) {
    <div class="error-banner">
      <p>{{ error() }}</p>
      <button mat-button type="button" (click)="retry()">Retry</button>
    </div>
  }

  @if (showBackToTop()) {
    <div class="back-to-top-fab-wrapper floating-fab-right">
      <button
        mat-fab
        class="back-to-top-fab floating-fab"
        [class.visible]="isBackToTopVisible()"
        (click)="scrollToTop()"
        aria-label="Scroll to top"
        [attr.aria-hidden]="!isBackToTopVisible()"
      >
        <mat-icon>arrow_upward</mat-icon>
      </button>
    </div>
  }
</main>
