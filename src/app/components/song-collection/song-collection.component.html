<main class="song-collection-root">
  <section class="song-collection-header">
    <div class="song-collection-header__titles">
      <div class="song-collection-header__title-row">
        <h1>{{ headerTitle() }}</h1>
        @if (headerInfoButton()) {
          <button
            mat-icon-button
            type="button"
            [attr.aria-label]="headerInfoButton()?.ariaLabel"
            aria-haspopup="dialog"
            (click)="onHeaderInfoButtonClick()"
          >
            <mat-icon aria-hidden="true">info</mat-icon>
          </button>
        }
      </div>
      @if (headerSubtitle()) {
        <p class="song-collection-header__subtitle">{{ headerSubtitle() }}</p>
      }
    </div>
    @if (hasHeaderSearchControls() || hasSortingOptions()) {
      <div class="song-collection-header-controls" role="toolbar" aria-label="Collection controls">
        @if (hasHeaderSearchControls()) {
          <div class="song-collection-header-controls__search">
            <ng-container *ngTemplateOutlet="headerSearchControls"></ng-container>
          </div>
          <div
            class="song-collection-header-controls__search-trigger"
            cdkOverlayOrigin
            #headerSearchOverlayOrigin="cdkOverlayOrigin"
          >
            <button
              mat-icon-button
              type="button"
              (click)="toggleHeaderSearchOverlay()"
              [attr.aria-label]="
                isHeaderSearchOverlayOpen() ? 'Hide search' : headerSearchAriaLabel()
              "
              aria-haspopup="dialog"
              [attr.aria-expanded]="isHeaderSearchOverlayOpen()"
              [attr.aria-controls]="headerSearchContainerId"
              class="song-collection-search-trigger"
            >
              <mat-icon aria-hidden="true">search</mat-icon>
              @if (hasActiveHeaderFilter()) {
                <span class="song-collection-search-trigger__badge" aria-hidden="true">!</span>
              }
            </button>
          </div>
          <ng-template
            cdk-connected-overlay
            [cdkConnectedOverlayOrigin]="headerSearchOverlayOrigin"
            [cdkConnectedOverlayOpen]="isHeaderSearchOverlayOpen()"
            [cdkConnectedOverlayPositions]="headerSearchOverlayPositions"
            [cdkConnectedOverlayFlexibleDimensions]="true"
            [cdkConnectedOverlayPush]="true"
            [cdkConnectedOverlayHasBackdrop]="true"
            cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
            (backdropClick)="closeHeaderSearchOverlay()"
            (detach)="closeHeaderSearchOverlay()"
          >
            <div
              class="song-collection-search-overlay"
              role="dialog"
              [attr.id]="headerSearchContainerId"
              aria-label="Library search"
            >
              <div class="song-collection-search-overlay__body">
                <div class="song-collection-search-overlay__fields">
                  <ng-container *ngTemplateOutlet="headerSearchControls"></ng-container>
                </div>
                <button
                  mat-icon-button
                  type="button"
                  class="song-collection-search-overlay__close"
                  aria-label="Close search panel"
                  (click)="closeHeaderSearchOverlay()"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </ng-template>
        }

        @if (hasSortingOptions()) {
          <div class="song-collection-sort-trigger">
            <button
              mat-icon-button
              type="button"
              [matMenuTriggerFor]="sortMenu"
              [attr.aria-label]="sortingLabel()"
              [attr.aria-expanded]="isSortingMenuOpen()"
            >
              <mat-icon>sort</mat-icon>
            </button>
            <mat-menu
              #sortMenu="matMenu"
              (opened)="onSortingMenuOpened()"
              (closed)="onSortingMenuClosed()"
              xPosition="before"
              yPosition="below"
            >
              <mat-chip-listbox
                multiple
                aria-label="Sort options"
                class="song-collection-sorting-panel__chip-list mat-mdc-chip-set-stacked"
              >
                @for (option of sortingChips(); track option.key) {
                  <mat-chip
                    [color]="isSortingChipActive(option) ? 'primary' : undefined"
                    [class.song-collection-sorting-chip--active]="isSortingChipActive(option)"
                    [disabled]="option.disabled"
                    (click)="handleSortingChipClick(option); $event.stopPropagation()"
                    [attr.aria-pressed]="isSortingChipActive(option)"
                    role="button"
                  >
                    {{ option.label }}
                    @if (getSortingDirectionIcon(option)) {
                      <mat-icon matChipTrailingIcon aria-hidden="true">{{
                        getSortingDirectionIcon(option)
                      }}</mat-icon>
                    }
                  </mat-chip>
                }
              </mat-chip-listbox>
            </mat-menu>
          </div>
        }
      </div>
    }
  </section>

  <ng-template #headerSearchControls>
    @for (control of headerControls(); track control.id ?? control.label) {
      <mat-form-field
        appearance="outline"
        subscriptSizing="dynamic"
        class="song-collection-control-search-field"
      >
        <mat-label class="song-collection-control-search-label">{{ control.label }}</mat-label>
        <input
          matInput
          type="search"
          [placeholder]="control.placeholder ?? control.label"
          [value]="control.value"
          (input)="handleHeaderSearchInput(control, $event)"
          (keydown.enter)="handleHeaderSearchSubmit()"
        />
        <button
          mat-icon-button
          matSuffix
          type="button"
          class="song-collection-search-submit"
          (click)="handleHeaderSearchSubmit()"
          aria-label="Apply search"
        >
          <mat-icon>search</mat-icon>
        </button>
      </mat-form-field>
    }
  </ng-template>

  @if (isInitialLoading()) {
    <div class="loading-state">
      <app-loading-skeleton
        [count]="skeletonCount()"
        [rows]="skeletonRows()"
        [cols]="skeletonCols()"
      />
    </div>
  } @else {
    <div class="scroll-container" #scrollContainer>
      @if (shouldShowEmptyState() && emptyStateTemplate()) {
        <ng-container *ngTemplateOutlet="emptyStateTemplate()"></ng-container>
      } @else {
        <app-song-list
          [songs]="visibleSongs()"
          [isUserLibrary]="isUserLibraryView()"
          [isSongInLibrary]="config().isSongInLibrary || defaultSongInLibrary"
          [isAuthenticated]="resolveIsAuthenticated()"
          (tileClick)="tileClick.emit($event)"
          (addToLibrary)="addToLibrary.emit($event)"
          (deleteClick)="deleteClick.emit($event)"
        />
      }

      @if (isPaginationLoading()) {
        <div class="pagination-loading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading more songs...</p>
        </div>
      }
    </div>
  }

  @if (error()) {
    <div class="error-banner">
      <p>{{ error() }}</p>
      <button mat-button type="button" (click)="retry()">Retry</button>
    </div>
  }

  @if (showBackToTop()) {
    <div class="back-to-top-fab-wrapper floating-fab-right">
      <button
        mat-fab
        class="back-to-top-fab floating-fab"
        [class.visible]="isBackToTopVisible()"
        (click)="scrollToTop()"
        aria-label="Scroll to top"
        [attr.aria-hidden]="!isBackToTopVisible()"
      >
        <mat-icon>arrow_upward</mat-icon>
      </button>
    </div>
  }
</main>
